{%  extends 'main.html' %}

{% load static %}
{% block content %}
<div class="row">
    <div class="col-12 col-md-10 offset-md-1" style="max-width: 1500px;margin-left: auto;margin-right: auto;">
        <div class="form-content">
            <div style="display: flex;justify-content: space-between; margin-top: .5rem;">
                <p>
                    <span class="badge badge-pill badge-dark mr-2">1</span>
                    Daten
                </p>
                <p>
                    <span class="badge badge-pill badge-dark mr-2">2</span>
                    Zusammenfassung
                </p>
            </div>
            <div class="card col-12 shadow-sm">
                <h5><i class="fas fa-shield-alt"></i>Ihre Versicherung</h5>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Tarif</p>
                    </div>
                    <div class="col-9">
                        <p>Mehr Zahnvorsorge</p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Beitrag</p>
                    </div>
                    <div class="col-9">
                        <div id="loader_beitrag" class="loader"></div>
                        <p id="beitrag" style="display: none;"></p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Beginn</p>
                    </div>
                    <div class="col-9">
                        <div id="loader_begin" class="loader"></div>
                        <p id="insurance_begin" style="display: none;"></p>
                    </div>
                </div>
            </div>
            <div class="card col-12 shadow-sm">
                <h5><i class="fas fa-tooth"></i>Zahnersatz (Optional)</h5>
                <div class="">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="mySwitch" name="darkmode" value="yes" onclick="show_zusatz()">
                        <label class="form-check-label" for="mySwitch">Sofort Kosten für Zahnersatz sichern!</label>
                    </div>
                </div>
                <div class="row">
                    <div id="zusatz" style="display: none;">
                        {% include 'components/banner.html' %}
                    </div>
                </div>
            </div>
            <div class="card col-12 shadow-sm">
                <h5><i class="fas fa-user"></i>Versicherte Person</h5>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Person</p>
                    </div>
                    <div class="col-9">
                        <p>
                            {{ request.session.anrede }} {{ request.session.vorname }} {{ request.session.nachname }} 
                            <br> 
                            {{ request.session.strasse }} {{ request.session.hausnr }} 
                            <br>
                            {{ request.session.plz }}, {{ request.session.ort }}
                        </p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Kontakt</p>
                    </div>
                    <div class="col-9">
                        <p>{{ request.session.email }}</p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Geburtsdatum</p>
                    </div>
                    <div class="col-9">
                        <p>{{ request.session.geburtsdatum }}</p>
                    </div>
                </div>
            </div>
            <div class="card col-12">
                <h5><i class="fas fa-wallet"></i>Ihre Bankdaten</h5>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>IBAN</p>
                    </div>
                    <div class="col-9">
                        <p>{{ request.session.iban }}</p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>BIC</p>
                    </div>
                    <div class="col-9">
                        <p id="bic">{{ request.session.bic }}</p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Bankname</p>
                    </div>
                    <div class="col-9">
                        <p id="bankname">{{ request.session.bankname }}</p>
                    </div>
                </div>
                <div class="row row-card">
                    <div class="col-3 key">
                        <p>Zahlungsart</p>
                    </div>
                    <div class="col-9">
                        <p>Sepa-Lastschriftmandat</p>
                    </div>
                </div>
            </div>
            <div class="card col-12 shadow-sm">
                <h5><i class="fas fa-file"></i>Ihre Dokumente</h5>
                <div id="loader_extra_angebot" style="display: none;">
                    <div class="loader"></div>
                    <p class="loading-text">Ihr Zahnersatzangebot wird erstellt ...</p>
                </div>
                <div id="extra_PDF" style="display: none;">
                    <i class="fas fa-regular fa-file-pdf" style="font-size: 1.7rem; color: #3e1a1a;"></i>
                    <a href="/media/pdfs/Mein_Extra_Angebot.pdf" download> Download - Ihr Zahnersatz Angebot</a>
                </div>
                <div id="extra_check" class="form-check mb-3"  style="margin-bottom: 2rem; margin-top: 1rem; display: none;" onclick="check_finish()">
                    <input class="form-check-input" type="checkbox" value="" id="input_extra_check">
                    <label class="form-check-label" for="flexCheckDefault">
                        Ja, ich habe die Extra Vertragsunterlagen zur Kenntnis genommen.
                    </label>
                </div>


                <div id="loader_angebot" style="display: none;">
                    <div class="loader"></div>
                    <p class="loading-text">Ihr Angebot wird erstellt ...</p>
                </div>
                <div id="personalizedPDF" style="display: none;">
                    <i class="fas fa-regular fa-file-pdf" style="font-size: 1.7rem; color: #3e1a1a;"></i>
                    <a href="/media/pdfs/Mein_Angebot.pdf" style="margin-bottom: 0px;" download> Download - Ihr Persönliches Angebot</a>
                </div>
                <div id="angebot_check" class="form-check" style="margin-bottom: 2rem; margin-top: 1rem; display: none;" onclick="check_finish()">
                    <input class="form-check-input" type="checkbox" value="" id="input_angebot_check">
                    <label class="form-check-label" for="flexCheckDefault">
                        Ja, ich habe die Vertragsunterlagen zur Kenntnis genommen.
                    </label>
                </div>


                <div style="display: flex; margin-bottom: 1rem;">
                    <i class="fas fa-regular fa-file-pdf" style="font-size: 1.7rem; color: #3e1a1a;"></i>
                    <a href="/media/pdfs/Schweigepflichtsentbindungserklärung.pdf" style="margin-bottom: 0px;" download>Download - Schweigepflichtsentbindungserklärung.pdf</a>
                </div>

                <div id="einwilligung_check" class="form-check" style="margin-bottom: 2rem;" onclick="check_finish()">
                    <input class="form-check-input" type="checkbox" value="" id="input_einwilligung_check">
                    <label class="form-check-label" for="flexCheckDefault">
                        Ich habe die "Einwilligung in die Erhebung und Verwendung von Gesundheitsdaten und Schweigepflichtsentbindungserklärung" gelesen und erteile die darin enthaltenen Einwilligungen.
                    </label>
                </div>
                <div id="privacy_check" class="form-check" onclick="check_finish()">
                    <input class="form-check-input" type="checkbox" value="" id="input_privacy_check">
                    <label class="form-check-label" for="flexCheckDefault">
                        Ich habe die Informationspflichten nach Art. 13 DSGVO zur Kenntnis genommen.
                    </label>
                </div>
            </div>
            <div style="display: flex; justify-content: center;">
                <input 
                    id="finish" 
                    onclick="finish_order()"
                    name="next" 
                    type="submit" 
                    value="Bitte warten" 
                    data-bs-toggle="modal" 
                    data-bs-target="#finishModalLoader" 
                    class="btn btn-primary col-12 col-md-3" 
                    style="margin-top: 1rem; margin-bottom: 1.2rem;" 
                    disabled>
            </div>

            
            <!-- Modal -->
            <div class="modal fade" id="finishModalLoader" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="finishModalLoaderLabel" aria-hidden="true">
                <div id="finish-dialog-loader" class="modal-dialog" role="document">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="justify-content: center;">
                                <h5 class="modal-title text-center" id="finishModalLabel">Ihr Vorgang wird bearbeitet</h5>
                            </div>
                            <div class="modal-body text-center" style="display: flex; justify-content: center;">
                                <div id="loader_finish">
                                    <div class="loader" style="width: 2rem; height: 2rem"></div>
                                    <p class="loading-text"></p>
                                </div> 
                            </div>
                        </div>
                    </div>
                </div>

                <div id="finish-dialog" class="modal-dialog" role="document" style="display: none; flex-direction: column;">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="justify-content: center;">
                                <h5 class="modal-title text-center" id="finishModalLabel">Glückwunsch</h5>
                            </div>
                            <div class="modal-body text-center">
                                Ihr Antragsvorgang wurde erfolgreich durchgeführt.
                            </div>
                        </div>
                    </div>
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="finishModalLabel">Wie geht es jetzt weiter?</h5>
                            </div>
                            <div class="modal-body">
                                <p>1. Ihr Versicherungsschein wird Ihnen innerhalb von einem Werktag per E-Mail zugestellt.</p>
                                <p>2. Alle versicherten Leistungen können Sie ab Erhalt Ihrer Vertragsdokumente direkt in Anspruch nehmen.</p>
                                <p>3. Rechnungen reichen Sie schnell und bequem per Smartphone-App oder per Email bei der Barmenia Krankenversicherung ein.</p>
                            </div>
                            <div class="modal-footer" style="display: flex;justify-content: center;">
                                <input 
                                    id="close_process" 
                                    name="next" 
                                    type="submit" 
                                    value="Verstanden" 
                                    class="btn btn-primary col-12 col-md-3" 
                                    style="margin-top: 1rem; margin-bottom: 1.2rem; min-width: 260px;">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- <div class="modal fade" id="finishModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="finishModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="justify-content: center;">
                                <h5 class="modal-title text-center" id="finishModalLabel">Glückwunsch</h5>
                            </div>
                            <div class="modal-body text-center">
                                Ihr Antragsvorgang wurde erfolgreich durchgeführt.
                            </div>
                        </div>
                    </div>
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="finishModalLabel">Wie geht es jetzt weiter?</h5>
                            </div>
                            <div class="modal-body">
                                <p>1. Ihr Versicherungsschein wird Ihnen innerhalb von einem Werktag per E-Mail zugestellt.</p>
                                <p>2. Alle versicherten Leistungen können Sie ab Erhalt Ihrer Vertragsdokumente direkt in Anspruch nehmen.</p>
                                <p>3. Rechnungen reichen Sie schnell und bequem per Smartphone-App oder per Email bei der Barmenia Krankenversicherung ein.</p>
                            </div>
                            <div class="modal-footer" style="display: flex;justify-content: center;">
                                <input 
                                    id="close_process" 
                                    name="next" 
                                    type="submit" 
                                    value="Verstanden" 
                                    class="btn btn-primary col-12 col-md-3" 
                                    style="margin-top: 1rem; margin-bottom: 1.2rem; min-width: 260px;">
                            </div>
                        </div>
                    </div>

                </div>
            </div> -->
        </div>
    </div>
</div>

<script>
    let iban = "{{ request.session.iban }}"
    let bic = ""
    let bankname = ""
    let state_offer_pdf =false
    let state_extra_pdf =false
    let extra_order = false
    let extra_behandlung
    let str_missing_teeth
    let current_contract
    let selection

    if ( window.history.replaceState ) {
         window.history.replaceState( null, null, window.location.href );
    }


    const systemSocket = new WebSocket(`ws://${window.location.host}/ws/scraper/`);

    systemSocket.onopen = function(e) {   
        console.log('systemsocket connected');
        context ={
            "message": "client-connected",
            "birthdate": "{{ request.session.geburtsdatum }}",
            "anrede": "{{ request.session.anrede }}",
            "vorname": "{{ request.session.vorname }}",
            "nachname": "{{ request.session.nachname }}",
            "plz": "{{ request.session.plz }}",
            "ort": "{{ request.session.ort }}",
            "strasse": "{{ request.session.strasse }}",
            "hausnr": "{{ request.session.hausnr }}",
            "email": "{{ request.session.email }}",
            "iban": "{{ request.session.iban }}"
        }
        systemSocket.send(JSON.stringify(context));

    };

    systemSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data)
        if (data.message == "set_uuid"){
            name='user-id'
            var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            if (match) {
                console.log(match[2]);
                if (match != data.uuid){
                    context ={
                        "message": "check-uuid-exists",
                        "uuid": match[2]
                    }
                    systemSocket.send(JSON.stringify(context));
                }
            }
            else{    
                document.cookie = name+"="+data.uuid + "; path=/";
            }
                
            
        }

        if (data.message == "checked-uuid"){
            console.log('checked uuid'+ data.uuid)
            if (data.checked==false){
                document.cookie = name+"="+data.uuid + "; path=/";
            }
        }

        if (data.message == "Congrats"){
            console.log('you son of a bitch, youre all set up')
            document.getElementById('finish-dialog-loader').style.display='none'
            document.getElementById('finish-dialog').style.display='flex'
        }
        if (data.message == "Done"){
            document.getElementById('loader_angebot').style.display = 'none'
            document.getElementById('angebot_check').style.display = 'flex'
            document.getElementById('personalizedPDF').style.display = 'flex'

            // document.getElementById('finish').disabled = false;
            // document.getElementById('finish').value = 'Abschließen';
        }
        if (data.message == "extra_done"){
            document.getElementById('loader_extra_angebot').style.display = 'none'
            document.getElementById('extra_PDF').style.display = 'flex'
            document.getElementById('extra_check').style.display ='flex'

            // document.getElementById('finish').disabled = false;
            // document.getElementById('finish').value = 'Abschließen';
        }
        if (data.message == "Beitrag"){
            document.getElementById('beitrag').innerText = data.price + ' € / Monat'
            document.getElementById('loader_beitrag').style.display = "none"
            document.getElementById('beitrag').style.display = 'block' 

            document.getElementById('insurance_begin').innerText = data.date
            document.getElementById('loader_begin').style.display = "none"
            document.getElementById('insurance_begin').style.display = 'block' 

            context ={
                "message": "beitrag-received",
                "birthdate": "{{ request.session.geburtsdatum }}",
                "anrede": "{{ request.session.anrede }}",
                "vorname": "{{ request.session.vorname }}",
                "nachname": "{{ request.session.nachname }}",
                "plz": "{{ request.session.plz }}",
                "ort": "{{ request.session.ort }}",
                "strasse": "{{ request.session.strasse }}",
                "hausnr": "{{ request.session.hausnr }}",
                "email": "{{ request.session.email }}",
                "iban": "{{ request.session.iban }}"
            }
            systemSocket.send(JSON.stringify(context));
            document.getElementById('loader_angebot').style.display='flex'


        }
        if (data.message == "serve_zahnzusatz_pricelist"){    
            document.getElementById('offer-small-eur').innerText = data.small
            document.getElementById('loader-col-small').style.display = "none"
            document.getElementById('offer-small').style.display = "flex"
            document.getElementById('extra_small').disabled = false        

            document.getElementById('offer-medium-eur').innerText = data.medium
            document.getElementById('loader-col-medium').style.display = "none"
            document.getElementById('offer-medium').style.display = "flex"
            document.getElementById('extra_medium').disabled = false

            document.getElementById('offer-large-eur').innerText = data.large
            document.getElementById('loader-col-large').style.display = "none"
            document.getElementById('offer-large').style.display = "flex"
            document.getElementById('extra_large').disabled = false

            document.getElementById('text1_damage2').innerText = data.damage_text.text1_damage2
            document.getElementById('text2_damage2').innerText = data.damage_text.text2_damage2
            document.getElementById('text3_damage2').innerText = data.damage_text.text3_damage2
            document.getElementById('text1_damage3').innerText = data.damage_text.text1_damage3
            document.getElementById('text2_damage3').innerText = data.damage_text.text2_damage3
            document.getElementById('text3_damage3').innerText = data.damage_text.text3_damage3
            
        }

        // if (data.message == "Finish"){
        //     context ={
        //         "message": "clear-data"
        //     }
        //     systemSocket.send(JSON.stringify(context));
        // }
    };
    
    systemSocket.onclose = function (e) {
        console.log('Chat socket closed');
    };

    // function send_message(){        
    //     systemSocket.send(JSON.stringify({"message": 'start'}));
    //     console.log()
    // }
    // function change_timeout(){        
    //     systemSocket.send(JSON.stringify({"message": 30}));
    // }
    // function stop_carrousel(){        
    //     systemSocket.send(JSON.stringify({"message": 'stop'}));
    // }
    // function reset(){        
    //     systemSocket.send(JSON.stringify({"message": 'reset'}));
    // }
        

    function show_zusatz(){
        context ={
            "message": "get_extra_pricelist",
            "birthdate": "{{ request.session.geburtsdatum }}"
        }
        systemSocket.send(JSON.stringify(context))
        banner = document.getElementById('zusatz')
        extra = document.getElementById('extra_PDF')

        if (banner.style.display == "none"){
            banner.style.display = "block";
            extra_order = true
        } else {
            banner.style.display = "none";
            extra.style.display = "none";
            extra_order =false
        }

    }


    function check_finish(){
        extra_check = document.getElementById('input_extra_check').checked
        angebot_check = document.getElementById('input_angebot_check').checked
        einwilligung_check = document.getElementById('input_einwilligung_check').checked
        privacy_check = document.getElementById('input_privacy_check').checked
        btn_finish = document.getElementById('finish')

        console.log(extra_order)

        if (extra_order ==true && extra_check && angebot_check && einwilligung_check && privacy_check){
            btn_finish.disabled = false;
            btn_finish.value = 'Abschließen';

        } else if (extra_order == false && angebot_check && einwilligung_check && privacy_check){
            btn_finish.disabled = false;
            btn_finish.value = 'Abschließen';

        } else {
            btn_finish.disabled = true;
            btn_finish.value = 'Bitte warten';          
        }
    }

    function finish_order(){
        context ={
            "message": "finish_orders",
            "birthdate": "{{ request.session.geburtsdatum }}",
            "anrede": "{{ request.session.anrede }}",
            "vorname": "{{ request.session.vorname }}",
            "nachname": "{{ request.session.nachname }}",
            "plz": "{{ request.session.plz }}",
            "ort": "{{ request.session.ort }}",
            "strasse": "{{ request.session.strasse }}",
            "hausnr": "{{ request.session.hausnr }}",
            "email": "{{ request.session.email }}",
            "iban": "{{ request.session.iban }}",
            "extra_behandlung": extra_behandlung,
            "missing_teeth": parseInt(str_missing_teeth),
            "current_contract": current_contract,
            "selection": selection

        }
        systemSocket.send(JSON.stringify(context))
    }
    
</script>


<style>
    .loading-text{
        margin-left: 1rem; 
        font-size: .9rem; 
        font-style: italic;
    }
    h5{
        margin-bottom: 1.7rem!important;
        font-weight: 700;
    }
    .card{
        margin-bottom: 1.5rem;
    }
    .row-card {
        padding-top: 0.2rem!important;
        padding-bottom: 0.2rem!important;
    }
    .key {
        max-width: 200px;
    }
    .controls{
        display: flex;
        justify-content: space-evenly;
    }

    .loader {
        border: 0.2rem solid #f3f3f3; /* Light grey */
        border-top: 0.2rem solid #3498db; /* Blue */
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>


{% endblock %}